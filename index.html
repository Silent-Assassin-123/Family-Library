<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Library</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            transition: background-color 0.3s ease, color 0.3s ease;
            background-size: 400% 400%; /* For animated gradient */
            animation: gradientBackground 15s ease infinite;
        }

        /* Animated Gradient Background */
        @keyframes gradientBackground {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }

        /* Light mode defaults */
        .light-mode {
            background-image: linear-gradient(225deg, #e0e7ff, #ede9fe, #dbeafe, #eef2ff); /* More complex gradient */
            color: #1a202c; /* text-gray-900 */
        }
        .light-mode .bg-white {
            background-color: #ffffff;
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 5px 15px -5px rgba(0, 0, 0, 0.04); /* Deeper shadow */
            border: 1px solid rgba(229, 231, 235, 0.7); /* Lighter border */
        }
        .light-mode .text-indigo-800 { color: #312e81; }
        .light-mode .text-indigo-700 { color: #4338ca; }
        .light-mode .text-gray-600 { color: #4b5563; }
        .light-mode .text-gray-500 { color: #6b7280; }
        .light-mode .text-gray-900 { color: #1a202c; }
        .light-mode .text-gray-700 { color: #374151; }
        .light-mode .border-gray-200 { border-color: #e5e7eb; }
        .light-mode .bg-gray-50 {
            background-color: #f9fafb;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 2px 4px -1px rgba(0, 0, 0, 0.03); /* Subtle shadow for list items */
        }
        .light-mode .hover\:bg-gray-100:hover { background-color: #f3f4f6; }
        .light-mode .border-gray-300 { border-color: #d1d5db; }
        .light-mode input, .light-mode select { background-color: #ffffff; color: #1a202c; border-color: #d1d5db; }


        /* Dark mode styles */
        .dark-mode {
            background-image: linear-gradient(225deg, #2d3748, #1a202c, #2c313a, #1f2733); /* Darker gradient */
            color: #e2e8f0; /* text-gray-100 */
        }
        .dark-mode .bg-white {
            background-color: #2d3748; /* dark equivalent */
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2), 0 5px 15px -5px rgba(0, 0, 0, 0.1); /* Deeper shadow for dark mode */
            border: 1px solid rgba(74, 85, 104, 0.7); /* Darker border */
        }
        .dark-mode .text-indigo-800 { color: #a5b4fc; /* text-indigo-300 */ }
        .dark-mode .text-indigo-700 { color: #818cf8; /* text-indigo-300 */ }
        .dark-mode .text-gray-600 { color: #a0aec0; /* text-gray-300 */ }
        .dark-mode .text-gray-500 { color: #a0aec0; /* text-gray-400 */ }
        .dark-mode .text-gray-900 { color: #e2e8f0; /* text-gray-100 */ }
        .dark-mode .text-gray-700 { color: #cbd5e0; /* text-gray-300 */ }
        .dark-mode .border-gray-200 { border-color: #4a5568; /* dark equivalent */ }
        .dark-mode .bg-gray-50 {
            background-color: #2d3748; /* dark equivalent */
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.08);
        }
        .dark-mode .hover\:bg-gray-100:hover { background-color: #4a5568; /* dark equivalent */ }
        .dark-mode .border-gray-300 { border-color: #4a5568; /* dark equivalent */ }
        .dark-mode input, .dark-mode select { background-color: #4a5568; color: #e2e8f0; border-color: #4a5568; }
        .dark-mode input.focus\:border-indigo-500:focus,
        .dark-mode input.focus\:ring-indigo-500:focus {
            border-color: #818cf8;
            box-shadow: 0 0 0 1px #818cf8;
        }

        /* Enhanced Button Styling */
        .btn-primary {
            background: linear-gradient(to right, #6366f1, #818cf8); /* Indigo to light indigo */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3);
        }
        .btn-primary:hover {
            background: linear-gradient(to right, #4f46e5, #6366f1);
            box-shadow: 0 6px 15px rgba(99, 102, 241, 0.4);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background-color: #ffffff;
            color: #374151;
            border: 1px solid #d1d5db;
            transition: all 0.3s ease;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }
        .btn-secondary:hover {
            background-color: #f3f4f6;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        }
        .dark-mode .btn-secondary {
            background-color: #2d3748;
            color: #cbd5e0;
            border-color: #4a5568;
        }
        .dark-mode .btn-secondary:hover {
            background-color: #4a5568;
        }


        .btn-green {
            background: linear-gradient(to right, #34d399, #10b981); /* Emerald green */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(52, 211, 153, 0.3);
        }
        .btn-green:hover {
            background: linear-gradient(to right, #10b981, #059669);
            box-shadow: 0 6px 15px rgba(52, 211, 153, 0.4);
            transform: translateY(-1px);
        }

        .btn-yellow {
            background: linear-gradient(to right, #fbbf24, #f59e0b); /* Amber yellow */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(251, 191, 36, 0.3);
        }
        .btn-yellow:hover {
            background: linear-gradient(to right, #f59e0b, #d97706);
            box-shadow: 0 6px 15px rgba(251, 191, 36, 0.4);
            transform: translateY(-1px);
        }

        .btn-red {
            background: linear-gradient(to right, #ef4444, #dc2626); /* Red */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(239, 68, 68, 0.3);
        }
        .btn-red:hover {
            background: linear-gradient(to right, #dc2626, #b91c1c);
            box-shadow: 0 6px 15px rgba(239, 68, 68, 0.4);
            transform: translateY(-1px);
        }

        .btn-blue {
            background: linear-gradient(to right, #3b82f6, #2563eb); /* Blue */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        .btn-blue:hover {
            background: linear-gradient(to right, #2563eb, #1d4ed8);
            box-shadow: 0 6px 15px rgba(59, 130, 246, 0.4);
            transform: translateY(-1px);
        }

        .btn-purple {
            background: linear-gradient(to right, #a855f7, #9333ea); /* Purple */
            color: white;
            transition: all 0.3s ease;
            box-shadow: 0 4px 10px rgba(168, 85, 247, 0.3);
        }
        .btn-purple:hover {
            background: linear-gradient(to right, #9333ea, #7e22ce);
            box-shadow: 0 6px 15px rgba(168, 85, 247, 0.4);
            transform: translateY(-1px);
        }

        /* Enhanced list item hover effect */
        .book-list-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px -5px rgba(0, 0, 0, 0.15), 0 4px 10px -5px rgba(0, 0, 0, 0.08);
        }
        .dark-mode .book-list-item:hover {
            box-shadow: 0 8px 20px -5px rgba(0, 0, 0, 0.3), 0 4px 10px -5px rgba(0, 0, 0, 0.15);
        }

        /* Adjust input focus styles for better contrast */
        input:focus {
            outline: none;
            border-color: #6366f1 !important; /* Tailwind's indigo-500 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.3) !important; /* Tailwind's indigo-500 with opacity */
        }
        .dark-mode input:focus {
            border-color: #818cf8 !important;
            box-shadow: 0 0 0 3px rgba(129, 140, 248, 0.3) !important;
        }

        /* Ensure heading colors are affected by theme */
        .text-header-light { color: #312e81; /* indigo-800 */ }
        .text-header-dark { color: #a5b4fc; /* indigo-300 */ }

        .text-sub-header-light { color: #4338ca; /* indigo-700 */ }
        .text-sub-header-dark { color: #818cf8; /* indigo-300 */ }

    </style>
</head>
<body class="light-mode">
    <div id="app" class="min-h-screen p-4">
        <!-- Content will be rendered here by JavaScript -->
        <div class="min-h-screen flex items-center justify-center">
            <p id="loading-message" class="text-xl text-indigo-700 animate-pulse">Loading library...</p>
        </div>
    </div>

    <!-- Supabase SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <script type="module">
        let createClient;
        if (window.supabase) {
            createClient = window.supabase.createClient;
        } else {
            console.error("Supabase SDK not loaded on window.supabase. Please check CDN script.");
        }

        const SUPABASE_URL = 'https://nhoozjzvkydxwlrshqis.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ob296anp2a3lkeHdscnNocWlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NzMyNDEsImV4cCI6MjA2NjM0OTI0MX0.5PfsT7CBIBOIziR8k0FsMPZzW0z7EzVrzFaWvhOIK9M';

        let supabase = null;
        let userId = null;
        let userEmail = null;
        let isAdmin = false;
        let books = [];
        let editingBook = null;

        const adminUids = [
            'ca6c353e-d022-4bef-b567-e02ecdbc552d', // Replace with anirudhrajesh04@gmail.com's UID
            '89c9470e-abfb-490e-9564-6d2c477d0c9e'  // Replace with anirudhrajesh999@gmail.com's UID
        ];

        const appDiv = document.getElementById('app');
        const loadingMessage = document.getElementById('loading-message');


        // --- Supabase Initialization ---
        async function initializeSupabase() {
            try {
                if (!createClient) {
                    console.error("createClient is not available. Supabase SDK might not be loaded correctly.");
                    loadingMessage.textContent = "Error: Supabase SDK failed to load.";
                    alert("Error initializing Supabase. Check console for details.");
                    return;
                }

                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                window.supabaseClient = supabase; // Expose for console debugging

                supabase.auth.onAuthStateChange((event, session) => {
                    if (session && session.user) {
                        userId = session.user.id;
                        userEmail = session.user.email;
                        isAdmin = adminUids.includes(userId);
                        console.log("Supabase Auth User:", userId, "Email:", userEmail, "Is Admin:", isAdmin, "Auth Event:", event);
                        renderView('main'); // Show main app if logged in
                    } else {
                        userId = null;
                        userEmail = null;
                        isAdmin = false;
                        console.log("No Supabase user session. Auth Event:", event);
                        renderView('auth'); // Show login page if not logged in
                    }
                    loadingMessage.style.display = 'none';
                    updateUserInfoDisplay(); // Update user info display immediately
                    setupRealtimeBooksListener(); // Re-setup listener on auth change
                });

                // Initial check for existing session
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                if (user) {
                    userId = user.id;
                    userEmail = user.email;
                    isAdmin = adminUids.includes(userId);
                    loadingMessage.style.display = 'none';
                    renderView('main');
                } else {
                    loadingMessage.style.display = 'none';
                    renderView('auth');
                }
                updateUserInfoDisplay();
                setupRealtimeBooksListener();

            } catch (error) {
                console.error("Error initializing Supabase:", error);
                loadingMessage.textContent = "Failed to load library.";
                alert(`Failed to initialize the application: ${error.message}. Please check console.`);
            }
        }

        // --- Fetch Book Details from Supabase ---
        async function fetchAndRenderBooks() {
            if (!supabase) return;

            const { data, error } = await supabase
                .from('books')
                .select(`
                    id,
                    title,
                    author,
                    isbn,
                    borrowed_by,
                    last_modified,
                    added_by
                `);

            if (error) {
                console.error("Error fetching books from Supabase:", error);
                alert("Error fetching books. Please check Supabase setup and RLS policies.");
                return;
            }

            books = data.map(book => {
                let displayBorrowedBy = book.borrowed_by;
                if (book.borrowed_by && userId && book.borrowed_by === userId) {
                    displayBorrowedBy = userEmail || book.borrowed_by;
                } else if (book.borrowed_by) {
                    displayBorrowedBy = book.borrowed_by;
                }

                let displayAddedBy = book.added_by;
                if (book.added_by && userId && book.added_by === userId) {
                    displayAddedBy = userEmail || book.added_by;
                } else if (book.added_by) {
                    displayAddedBy = book.added_by;
                }

                return {
                    ...book,
                    displayBorrowedBy: displayBorrowedBy,
                    displayAddedBy: displayAddedBy
                };
            }).sort((a, b) => a.title.localeCompare(b.title));

            renderBookList();
        }

        // --- Real-time Books Listener ---
        function setupRealtimeBooksListener() {
            if (!supabase) return;

            supabase.removeAllChannels();

            supabase
                .channel('books_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'books' }, payload => {
                    console.log('Change received!', payload);
                    fetchAndRenderBooks();
                })
                .subscribe();

            fetchAndRenderBooks();
        }

        // --- Fetch Book Details from Google Books API by ISBN ---
        async function fetchBookDetailsByIsbn() {
            const isbnSearchInput = document.getElementById('isbn-search-input').value.trim();
            if (!isbnSearchInput) {
                alert("Please enter an ISBN.");
                return;
            }

            const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbnSearchInput}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    const volumeInfo = data.items[0].volumeInfo;
                    document.getElementById('book-title').value = volumeInfo.title || '';
                    document.getElementById('book-author').value = volumeInfo.authors ? volumeInfo.authors.join(', ') : '';
                    document.getElementById('book-isbn').value = isbnSearchInput;
                    alert("Book details fetched successfully!");
                } else {
                    alert("No book found for this ISBN. Please enter details manually.");
                    document.getElementById('book-title').value = '';
                    document.getElementById('book-author').value = '';
                    document.getElementById('book-isbn').value = isbnSearchInput;
                }
            } catch (error) {
                console.error("Error fetching book details:", error);
                alert("Error fetching book details. Please check the ISBN or your internet connection.");
                document.getElementById('book-title').value = '';
                document.getElementById('book-author').value = '';
                document.getElementById('book-isbn').value = isbnSearchInput;
            }
        }

        // --- Add/Update Book ---
        async function handleAddUpdateBook(event) {
            event.preventDefault();

            const title = document.getElementById('book-title').value.trim();
            const author = document.getElementById('book-author').value.trim();
            const isbn = document.getElementById('book-isbn').value.trim();

            if (!title || !author) {
                alert("Book title and author cannot be empty.");
                return;
            }

            if (!supabase) {
                alert("Supabase client not initialized. Please try again.");
                return;
            }

            try {
                if (editingBook) {
                    const { data, error } = await supabase
                        .from('books')
                        .update({
                            title: title,
                            author: author,
                            isbn: isbn,
                            "last_modified": new Date().toISOString()
                        })
                        .eq('id', editingBook.id);

                    if (error) throw error;

                    alert("Book updated successfully!");
                    editingBook = null;
                    document.getElementById('add-edit-book-form').reset();
                    document.getElementById('add-edit-form-title').textContent = 'Add New Book';
                    document.getElementById('add-update-button').textContent = 'Add Book';
                    document.getElementById('cancel-edit-button').classList.add('hidden');
                    document.getElementById('isbn-search-section').classList.remove('hidden');
                } else {
                    const { data, error } = await supabase
                        .from('books')
                        .insert([
                            {
                                title: title,
                                author: author,
                                isbn: isbn,
                                "borrowed_by": null,
                                "added_by": userId
                            }
                        ]);

                    if (error) throw error;

                    alert("Book added successfully!");
                    document.getElementById('add-edit-book-form').reset();
                    document.getElementById('isbn-search-input').value = '';
                }
            } catch (e) {
                console.error("Error saving book: ", e);
                alert(`Error saving book: ${e.message}. Please check RLS policies and admin permissions.`);
            }
        }

        // --- Handle Edit Click ---
        function handleEditClick(bookId) {
            editingBook = books.find(b => b.id === bookId);
            if (editingBook) {
                document.getElementById('book-title').value = editingBook.title;
                document.getElementById('book-author').value = editingBook.author;
                document.getElementById('book-isbn').value = editingBook.isbn;

                document.getElementById('add-edit-form-title').textContent = 'Edit Book Details';
                document.getElementById('add-update-button').textContent = 'Update Book';
                document.getElementById('cancel-edit-button').classList.remove('hidden');
                document.getElementById('isbn-search-section').classList.add('hidden');
            }
        }

        // --- Handle Cancel Edit ---
        function handleCancelEdit() {
            editingBook = null;
            document.getElementById('add-edit-book-form').reset();
            document.getElementById('add-edit-form-title').textContent = 'Add New Book';
            document.getElementById('add-update-button').textContent = 'Add Book';
            document.getElementById('cancel-edit-button').classList.add('hidden');
            document.getElementById('isbn-search-section').classList.remove('hidden');
        }

        // --- Handle Borrow/Return ---
        async function handleBorrowReturn(bookId, currentBorrowedByUid) {
            if (!supabase || !userId) {
                alert("You must be logged in to borrow or return books.");
                return;
            }

            let message = '';
            let newBorrowedByValue = null;

            if (currentBorrowedByUid && currentBorrowedByUid !== 'null') {
                if (currentBorrowedByUid === userId) {
                    newBorrowedByValue = null;
                    message = "Book returned successfully!";
                } else {
                    alert("This book is borrowed by another user. Only the borrower can return it.");
                    return;
                }
            } else {
                newBorrowedByValue = userId;
                message = `Book borrowed by you!`;
            }

            try {
                const { data, error } = await supabase
                    .from('books')
                    .update({
                        "borrowed_by": newBorrowedByValue,
                        "last_modified": new Date().toISOString()
                    })
                    .eq('id', bookId);

                if (error) throw error;
                alert(message);
            } catch (e) {
                console.error("Error updating borrow status: ", e);
                alert(`Error updating borrow status: ${e.message}. Please check RLS policies.`);
            }
        }

        // --- Handle Delete Book ---
        async function handleDeleteBook(bookId) {
            if (!supabase) {
                alert("Supabase client not initialized. Please try again.");
                return;
            }

            if (!isAdmin) {
                alert("Only administrators can delete books.");
                return;
            }

            const confirmDelete = confirm("Are you sure you want to delete this book?");
            if (confirmDelete) {
                try {
                    const { error } = await supabase
                        .from('books')
                        .delete()
                        .eq('id', bookId);

                    if (error) throw error;
                    alert("Book deleted successfully!");
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    alert(`Error deleting book: ${e.message}. Please check RLS policies.`);
                }
            } else {
                alert("Delete action cancelled.");
            }
        }

        // --- Authentication Functions ---
        async function handleAuth(event, isSignUp) {
            event.preventDefault();
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();

            if (!email || !password) {
                alert("Email and password cannot be empty.");
                return;
            }

            if (!supabase) {
                alert("Supabase client not initialized. Please try again.");
                return;
            }

            try {
                let response;
                if (isSignUp) {
                    response = await supabase.auth.signUp({ email, password });
                    if (response.error) {
                        throw response.error;
                    }
                    if (response.data.user) {
                        alert("Sign up successful and logged in!");
                    } else {
                        // This case is for when email confirmation is required but no auto-login happens
                        alert("Sign up successful! Please check your email to confirm your account.");
                    }
                } else { // is login
                    response = await supabase.auth.signInWithPassword({ email, password });
                    if (response.error) {
                        throw response.error;
                    }
                    alert("Login successful!");
                }
                // onAuthStateChange listener will now handle renderView('main') on success
            } catch (error) {
                console.error("Auth error:", error);
                alert(`Authentication failed: ${error.message}`);
            }
        }

        async function handleLogout() {
            if (!supabase) return;
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                alert("You have been logged out.");
                // Auth state change listener will handle view rendering
            } catch (error) {
                console.error("Logout error:", error);
                alert(`Logout failed: ${error.message}`);
            }
        }


        // --- View Rendering Logic ---
        function renderView(viewName) {
            let htmlContent = '';
            const isDarkMode = document.body.classList.contains('dark-mode');

            if (viewName === 'auth') {
                htmlContent = `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg">
                            <h2 class="text-3xl font-bold text-center text-sub-header-light mb-6">
                                Welcome to Family Library
                            </h2>
                            <form id="auth-form" class="space-y-4">
                                <div>
                                    <label for="auth-email" class="block text-sm font-medium text-gray-700 mb-1">
                                        Email
                                    </label>
                                    <input type="email" id="auth-email" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="your.email@example.com" required/>
                                </div>
                                <div>
                                    <label for="auth-password" class="block text-sm font-medium text-gray-700 mb-1">
                                        Password
                                    </label>
                                    <input type="password" id="auth-password" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="••••••••" required/>
                                </div>
                                <div class="flex flex-col space-y-3">
                                    <button type="submit" id="login-button" class="px-6 py-3 rounded-lg font-medium shadow w-full btn-primary">
                                        Login
                                    </button>
                                    <button type="button" id="signup-button" class="px-6 py-3 rounded-md shadow-sm text-sm font-medium w-full btn-secondary">
                                        Sign Up
                                    </button>
                                </div>
                            </form>
                            <button id="theme-toggle" class="mt-8 px-4 py-2 rounded-lg font-medium shadow transition duration-150 ease-in-out bg-gray-200 text-gray-800 hover:bg-gray-300 w-full">
                                ${isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                            </button>
                        </div>
                    </div>
                `;
                appDiv.innerHTML = htmlContent;
                document.getElementById('auth-form').addEventListener('submit', (e) => handleAuth(e, false));
                document.getElementById('signup-button').addEventListener('click', (e) => handleAuth(e, true));
                document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

            } else if (viewName === 'main') {
                htmlContent = `
                    <header class="text-center mb-8">
                        <h1 class="text-4xl font-extrabold mb-2 text-header-light">
                            Family Library
                        </h1>
                        <p class="text-lg text-gray-600">
                            Your personal book tracker for the whole family.
                        </p>
                        <p class="text-sm mt-2 text-gray-500" id="user-info">
                            Logged in as: <span class="font-semibold">${userEmail || userId || 'Anonymous'}</span>
                            ${isAdmin ? `<span class="ml-2 px-2 py-1 bg-yellow-400 text-yellow-900 rounded-full text-xs font-bold">ADMIN</span>` : ''}
                            <button id="logout-button" class="ml-4 px-3 py-1 rounded-lg shadow text-xs btn-red">
                                Logout
                            </button>
                        </p>
                        <button id="theme-toggle" class="mt-4 px-4 py-2 rounded-lg font-medium shadow transition duration-150 ease-in-out bg-gray-200 text-gray-800 hover:bg-gray-300">
                            ${isDarkMode ? 'Switch to Light Mode' : 'Switch to Dark Mode'}
                        </button>
                    </header>

                    <!-- Add/Edit Book Form -->
                    <div id="add-edit-form-container" class="max-w-xl mx-auto p-8 rounded-xl shadow-lg mb-8 bg-white ${isAdmin ? '' : 'hidden'}">
                        <h2 id="add-edit-form-title" class="text-2xl font-bold text-sub-header-light mb-6">
                            Add New Book
                        </h2>

                        <div id="isbn-search-section" class="mb-6 border-b border-gray-200 pb-4">
                            <h3 class="text-xl font-semibold text-gray-700 mb-3">Add by ISBN</h3>
                            <div class="flex space-x-2">
                                <input type="text" id="isbn-search-input" placeholder="Enter ISBN" class="flex-grow px-4 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm"/>
                                <button type="button" id="fetch-isbn-button" class="px-5 py-2 rounded-lg font-medium shadow btn-purple">
                                    Fetch Details
                                </button>
                            </div>
                            <p class="text-center text-sm my-4 text-gray-500">
                                — OR —
                            </p>
                        </div>

                        <form id="add-edit-book-form" class="space-y-4">
                            <div>
                                <label for="book-title" class="block text-sm font-medium text-gray-700 mb-1">
                                    Title
                                </label>
                                <input type="text" id="book-title" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="e.g., The Hobbit" required/>
                            </div>
                            <div>
                                <label for="book-author" class="block text-sm font-medium text-gray-700 mb-1">
                                    Author
                                </label>
                                <input type="text" id="book-author" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="e.g., J.R.R. Tolkien" required/>
                            </div>
                            <div>
                                <label for="book-isbn" class="block text-sm font-medium text-gray-700 mb-1">
                                    ISBN (Optional)
                                </label>
                                <input type="text" id="book-isbn" class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm" placeholder="e.g., 978-0-618-00221-4"/>
                            </div>
                            <div class="flex justify-end space-x-3">
                                <button type="button" id="cancel-edit-button" class="px-5 py-2 rounded-md shadow-sm text-sm font-medium hidden btn-secondary">
                                    Cancel
                                </button>
                                <button type="submit" id="add-update-button" class="px-6 py-2 rounded-lg font-medium shadow btn-primary">
                                    Add Book
                                </button>
                            </div>
                        </form>
                    </div>

                    <!-- Search Bar -->
                    <div class="max-w-xl mx-auto bg-white p-6 rounded-xl shadow-lg mb-8">
                        <h2 class="text-2xl font-bold text-sub-header-light mb-4">Search Books</h2>
                        <input type="text" id="search-input" placeholder="Search by title, author, or ISBN..." class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm sm:text-sm"/>
                    </div>

                    <!-- Book List -->
                    <div class="max-w-3xl mx-auto bg-white p-8 rounded-xl shadow-lg">
                        <h2 class="text-2xl font-bold text-sub-header-light mb-6">Your Books</h2>
                        <ul id="book-list" class="space-y-4">
                            <!-- Books will be rendered here -->
                        </ul>
                    </div>
                `;
                appDiv.innerHTML = htmlContent;
                document.getElementById('add-edit-book-form').addEventListener('submit', handleAddUpdateBook);
                document.getElementById('fetch-isbn-button').addEventListener('click', fetchBookDetailsByIsbn);
                document.getElementById('cancel-edit-button').addEventListener('click', handleCancelEdit);
                document.getElementById('search-input').addEventListener('input', renderBookList);
                document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
                document.getElementById('logout-button').addEventListener('click', handleLogout);

                renderBookList(); // Initial render of books for the main view
            }
            applyTheme(localStorage.getItem('theme') || 'light');
            updateUserInfoDisplay();
        }

        // --- Update User Info Display ---
        function updateUserInfoDisplay() {
            const userInfoSpan = document.getElementById('user-info');
            if (userInfoSpan) {
                userInfoSpan.innerHTML = `
                    Logged in as: <span class="font-semibold">${userEmail || userId || 'Anonymous'}</span>
                    ${isAdmin ? `<span class="ml-2 px-2 py-1 bg-yellow-400 text-yellow-900 rounded-full text-xs font-bold">ADMIN</span>` : ''}
                    ${userId ? `
                    <button id="logout-button" class="ml-4 px-3 py-1 rounded-lg shadow text-xs btn-red">
                        Logout
                    </button>
                    ` : ''}
                `;
                // Re-attach logout listener if it's rendered dynamically
                const logoutButton = document.getElementById('logout-button');
                if (logoutButton) {
                    logoutButton.onclick = handleLogout;
                }
            }

            const addEditFormContainer = document.getElementById('add-edit-form-container');
            if (addEditFormContainer) {
                if (isAdmin) {
                    addEditFormContainer.classList.remove('hidden');
                } else {
                    addEditFormContainer.classList.add('hidden');
                }
            }
        }


        // --- Render Book List ---
        function renderBookList() {
            const bookListElement = document.getElementById('book-list');
            // Check if bookListElement exists before proceeding (it won't on the auth page)
            if (!bookListElement) return;

            const searchInput = document.getElementById('search-input');
            const searchQuery = searchInput ? searchInput.value.toLowerCase() : '';

            let filteredBooks = books.filter(book =>
                book.title.toLowerCase().includes(searchQuery) ||
                book.author.toLowerCase().includes(searchQuery) ||
                (book.isbn && book.isbn.toLowerCase().includes(searchQuery))
            );

            if (filteredBooks.length === 0) {
                bookListElement.innerHTML = `<p class="text-center text-gray-500">No books found. Add some books to get started!</p>`;
                return;
            }

            bookListElement.innerHTML = filteredBooks.map(book => `
                <li class="p-5 border rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center bg-gray-50 hover:bg-gray-100 border-gray-200 transition duration-150 ease-in-out book-list-item">
                    <div class="flex-grow mb-3 sm:mb-0">
                        <h3 class="text-xl font-semibold text-gray-900">${book.title}</h3>
                        <p class="text-gray-700">by <span class="font-medium">${book.author}</span></p>
                        ${book.isbn ? `<p class="text-sm text-gray-600">ISBN: ${book.isbn}</p>` : ''}
                        ${book.borrowed_by ?
                            `<p class="text-orange-600 font-bold mt-1">Borrowed by: ${book.displayBorrowedBy}</p>` :
                            `<p class="text-green-600 font-bold mt-1">Available</p>`
                        }
                        <p class="text-xs text-gray-500 mt-1">
                            Added by: ${book.displayAddedBy || 'Unknown'} |
                            Last modified: ${new Date(book.last_modified).toLocaleDateString()}
                        </p>
                    </div>
                    <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 w-full sm:w-auto">
                        <button onclick="handleBorrowReturn('${book.id}', ${book.borrowed_by ? `'${book.borrowed_by}'` : 'null'})"
                            class="px-4 py-2 rounded-lg font-medium shadow ${
                                book.borrowed_by
                                    ? 'btn-yellow' /* Changed to yellow for borrowed */
                                    : 'btn-green' /* Changed to green for available */
                            }">
                            ${book.borrowed_by ? 'Mark as Returned' : 'Mark as Borrowed'}
                        </button>
                        ${isAdmin ? `
                        <button onclick="handleEditClick('${book.id}')"
                            class="px-4 py-2 rounded-lg font-medium shadow btn-blue">
                            Edit
                        </button>
                        <button onclick="handleDeleteBook('${book.id}')"
                            class="px-4 py-2 rounded-lg font-medium shadow btn-red">
                            Delete
                        </button>
                        ` : ''}
                    </div>
                </li>
            `).join('');

            applyTheme(localStorage.getItem('theme') || 'light');
        }

        // --- Theme Toggle ---
        function toggleTheme() {
            const currentTheme = document.body.classList.contains('dark-mode') ? 'dark' : 'light';
            const newTheme = currentTheme === 'light' ? 'dark' : 'light';
            applyTheme(newTheme);
            localStorage.setItem('theme', newTheme);
        }

        function applyTheme(theme) {
            const body = document.body;
            // Select elements more specifically for theming
            const textHeaderElements = document.querySelectorAll('h1, h2');
            const textSubHeaderElements = document.querySelectorAll('h2');
            const textMutedElements = document.querySelectorAll('p.text-gray-600, p.text-gray-500, p.text-gray-700, .modal-buttons button.secondary');
            const inputElements = document.querySelectorAll('input, select');
            const bgWhiteElements = document.querySelectorAll('.bg-white');
            const bgGray50Elements = document.querySelectorAll('.bg-gray-50');
            const borderGray200Elements = document.querySelectorAll('.border-gray-200');
            const borderGray300Elements = document.querySelectorAll('.border-gray-300');
            const hoverGray100Elements = document.querySelectorAll('.hover\\:bg-gray-100');

            if (theme === 'dark') {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
                const themeToggleButton = document.getElementById('theme-toggle');
                if(themeToggleButton) themeToggleButton.textContent = 'Switch to Light Mode';

                textHeaderElements.forEach(el => {
                    el.classList.remove('text-header-light');
                    el.classList.add('text-header-dark');
                });
                textSubHeaderElements.forEach(el => {
                    el.classList.remove('text-sub-header-light');
                    el.classList.add('text-sub-header-dark');
                });
                textMutedElements.forEach(el => {
                    el.classList.remove('text-gray-600', 'text-gray-500', 'text-gray-700');
                    el.classList.add('text-gray-300');
                });
                inputElements.forEach(el => {
                    el.classList.add('dark-mode');
                });
                bgWhiteElements.forEach(el => el.classList.add('dark-mode'));
                bgGray50Elements.forEach(el => el.classList.add('dark-mode'));
                borderGray200Elements.forEach(el => el.classList.add('dark-mode'));
                borderGray300Elements.forEach(el => el.classList.add('dark-mode'));
                hoverGray100Elements.forEach(el => el.classList.add('dark-mode'));


            } else {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
                const themeToggleButton = document.getElementById('theme-toggle');
                if(themeToggleButton) themeToggleButton.textContent = 'Switch to Dark Mode';

                textHeaderElements.forEach(el => {
                    el.classList.remove('text-header-dark');
                    el.classList.add('text-header-light');
                });
                textSubHeaderElements.forEach(el => {
                    el.classList.remove('text-sub-header-dark');
                    el.classList.add('text-sub-header-light');
                });
                textMutedElements.forEach(el => {
                    // Re-add original light mode classes as appropriate
                    if (el.classList.contains('modal-buttons')) { /* specific handling if needed */ }
                    el.classList.remove('text-gray-300');
                    // Add appropriate original classes back if they were removed
                    if (el.tagName === 'P') {
                        if (el.textContent.includes('personal book tracker')) el.classList.add('text-gray-600');
                        else if (el.textContent.includes('Logged in as')) el.classList.add('text-gray-500');
                        else el.classList.add('text-gray-700'); // Default for labels/other p tags
                    } else if (el.tagName === 'LABEL') {
                         el.classList.add('text-gray-700');
                    } else if (el.tagName === 'BUTTON') {
                        el.classList.add('text-gray-700');
                    }
                });
                inputElements.forEach(el => {
                    el.classList.remove('dark-mode');
                });
                bgWhiteElements.forEach(el => el.classList.remove('dark-mode'));
                bgGray50Elements.forEach(el => el.classList.remove('dark-mode'));
                borderGray200Elements.forEach(el => el.classList.remove('dark-mode'));
                borderGray300Elements.forEach(el => el.classList.remove('dark-mode'));
                hoverGray100Elements.forEach(el => el.classList.remove('dark-mode'));
            }
        }


        // Expose functions to global scope for HTML event listeners
        window.handleBorrowReturn = handleBorrowReturn;
        window.handleEditClick = handleEditClick;
        window.handleDeleteBook = handleDeleteBook;
        window.toggleTheme = toggleTheme;
        window.applyTheme = applyTheme;
        window.handleAuth = handleAuth;
        window.handleLogout = handleLogout;

        // Initialize the app when the window loads
        window.onload = initializeSupabase;
    </script>
</body>
</html>
