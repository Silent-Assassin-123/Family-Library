<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Library</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        /* General Body and Container Styling */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a2e; /* Dark background */
            color: #e0e0e0; /* Light text */
            transition: background-color 0.3s, color 0.3s;
        }

        .dark-theme {
            background-color: #1a1a2e;
            color: #e0e0e0;
        }

        .light-theme {
            background-color: #f0f2f5;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 2rem;
            background-color: #16213e; /* Darker container */
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.4);
            transition: background-color 0.3s, box-shadow 0.3s;
        }

        .light-theme .container {
            background-color: #ffffff;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1);
        }

        /* Header and Auth Forms */
        h1, h2 {
            color: #e94560; /* Accent color */
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .light-theme h1, .light-theme h2 {
            color: #c9002a;
        }

        form {
            background-color: #0f3460; /* Form background */
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            transition: background-color 0.3s;
        }

        .light-theme form {
            background-color: #f9f9f9;
        }

        input[type="email"],
        input[type="password"],
        input[type="text"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 0.8rem;
            margin-bottom: 1rem;
            border: 1px solid #000000; /* Darker border for inputs */
            border-radius: 6px;
            background-color: #0f3460;
            color: #e0e0e0;
            transition: border-color 0.3s, background-color 0.3s;
        }

        .light-theme input[type="email"],
        .light-theme input[type="password"],
        .light-theme input[type="text"],
        .light-theme input[type="number"],
        .light-theme textarea {
            background-color: #ffffff;
            border-color: #ccc;
            color: #333;
        }

        input[type="email"]:focus,
        input[type="password"]:focus,
        input[type="text"]:focus,
        input[type="number"]:focus,
        textarea:focus {
            outline: none;
            border-color: #533483; /* Purple accent on focus */
            box-shadow: 0 0 0 3px rgba(83, 52, 131, 0.5);
        }

        button {
            background-color: #533483; /* Purple button */
            color: white;
            padding: 0.8rem 1.5rem;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s, transform 0.2s;
            font-weight: 600;
        }

        button:hover {
            background-color: #6a4a9f; /* Lighter purple on hover */
            transform: translateY(-2px);
        }

        .light-theme button {
            background-color: #7a5cd6;
        }
        .light-theme button:hover {
            background-color: #9078e6;
        }

        /* Error/Success Messages */
        .message {
            padding: 0.8rem;
            margin-bottom: 1rem;
            border-radius: 6px;
            text-align: center;
        }

        .message.error {
            background-color: #e94560; /* Red for error */
            color: white;
        }

        .message.success {
            background-color: #4CAF50; /* Green for success */
            color: white;
        }

        /* Book List */
        .book-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1.5rem;
        }

        .book-item {
            background-color: #0f3460;
            padding: 1rem;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            transition: background-color 0.3s, transform 0.2s;
            min-height: 200px; /* Ensure consistent height */
        }

        .light-theme .book-item {
            background-color: #ffffff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
        }

        .book-item:hover {
            transform: translateY(-5px);
        }

        .book-item h3 {
            color: #e94560;
            font-size: 1.3rem;
            margin-bottom: 0.5rem;
        }

        .book-item p {
            font-size: 0.9rem;
            line-height: 1.4;
            color: #b0b0b0;
        }

        .light-theme .book-item p {
            color: #555;
        }

        .book-item .actions {
            margin-top: 1rem;
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .book-item .actions button {
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            flex-grow: 1;
        }

        /* Loader */
        .loader {
            border: 8px solid #f3f3f3;
            border-top: 8px solid #533483;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
            margin: 50px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* Hidden class for elements */
        .hidden {
            display: none !important;
        }

        /* Main app view grid for better layout */
        .app-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        @media (min-width: 768px) {
            .app-grid {
                grid-template-columns: 1fr; /* Adjust as needed for larger screens */
            }
        }

        /* User Management */
        .user-item {
            background-color: #0f3460;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .light-theme .user-item {
            background-color: #f9f9f9;
        }
        .user-item span {
            font-weight: 600;
            color: #e0e0e0;
        }
        .light-theme .user-item span {
            color: #333;
        }
        .user-item .actions button {
            padding: 0.5rem 0.8rem;
            font-size: 0.8rem;
        }

        /* Profile Section */
        #profile-section form {
            max-width: 500px;
            margin-left: auto;
            margin-right: auto;
        }
        #profile-section p {
            text-align: center;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            justify-content: center;
            margin-bottom: 2rem;
            background-color: #0a1128; /* Slightly lighter background for tabs */
            border-radius: 8px;
            padding: 0.5rem;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
        }
        .light-theme .tab-nav {
            background-color: #e0e6ec;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.08);
        }

        .tab-nav button {
            flex-grow: 1;
            padding: 1rem 1.5rem;
            border: none;
            background-color: transparent;
            color: #a0a0a0;
            font-size: 1.1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 6px;
            transition: color 0.3s, background-color 0.3s, transform 0.2s;
            max-width: 200px; /* Limit tab width */
        }

        .tab-nav button:hover:not(.active) {
            color: #e0e0e0;
            background-color: #1a1a2e;
            transform: translateY(-2px);
        }
        .light-theme .tab-nav button:hover:not(.active) {
            color: #333;
            background-color: #f0f2f5;
        }

        .tab-nav button.active {
            background-color: #533483; /* Active tab color */
            color: white;
            box-shadow: 0 2px 10px rgba(83, 52, 131, 0.5);
            transform: translateY(-2px);
        }
        .light-theme .tab-nav button.active {
            background-color: #7a5cd6;
            box-shadow: 0 2px 10px rgba(122, 92, 214, 0.3);
        }

        /* Section specific margins */
        .tab-content-section {
            padding-top: 1rem;
        }
    </style>
</head>
<body class="dark-theme">
    <div class="container">
        <div id="auth-view" class="hidden">
            <h1 class="text-3xl font-bold mb-6">Welcome to Family Library</h1>
            <div id="auth-message" class="message hidden"></div>

            <form id="signup-form" class="mb-4">
                <h2 class="text-2xl font-semibold mb-4">Sign Up</h2>
                <input type="email" id="signup-email" placeholder="Email" required class="w-full p-3 rounded-md border border-gray-700 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-purple-600 mb-2">
                <input type="password" id="signup-password" placeholder="Password" required class="w-full p-3 rounded-md border border-gray-700 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-purple-600 mb-4">
                <button type="submit" class="w-full py-3 bg-purple-700 hover:bg-purple-800 text-white font-bold rounded-md transition duration-200">Sign Up</button>
            </form>

            <form id="signin-form">
                <h2 class="text-2xl font-semibold mb-4">Sign In</h2>
                <input type="email" id="signin-email" placeholder="Email" required class="w-full p-3 rounded-md border border-gray-700 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-purple-600 mb-2">
                <input type="password" id="signin-password" placeholder="Password" required class="w-full p-3 rounded-md border border-gray-700 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-purple-600 mb-4">
                <button type="submit" class="w-full py-3 bg-purple-700 hover:bg-purple-800 text-white font-bold rounded-md transition duration-200">Sign In</button>
            </form>
        </div>

        <div id="main-view" class="hidden app-grid">
            <div class="flex justify-between items-center mb-4">
                <h1 class="text-3xl font-bold flex-grow text-left" id="display-name-header">Welcome!</h1>
                <div class="flex items-center space-x-4">
                    <button id="theme-toggle" class="bg-gray-700 hover:bg-gray-600 text-white text-sm px-4 py-2 rounded-md">Toggle Theme</button>
                    <button id="signout-button" class="bg-red-700 hover:bg-red-800 text-white text-sm px-4 py-2 rounded-md">Sign Out</button>
                </div>
            </div>

            <div class="tab-nav" id="main-tab-nav">
                <button id="tab-my-books" data-tab="books-section" class="active">My Books</button>
                <button id="tab-add-book" data-tab="add-book-section" class="hidden">Add Book</button>
                <button id="tab-my-profile" data-tab="profile-section">My Profile</button>
                <button id="tab-users" data-tab="users-section" class="hidden">User Management</button>
            </div>

            <div id="books-section" class="tab-content-section">
                <h2 class="text-2xl font-semibold mb-4 text-center">My Books</h2>
                <input type="text" id="search-input" placeholder="Search books by title or author..." class="w-full p-3 rounded-md border border-gray-700 bg-gray-800 text-white focus:outline-none focus:ring-2 focus:ring-purple-600 mb-4">
                <div id="book-list" class="book-list">
                    </div>
                <div id="no-books-message" class="text-center text-gray-500 mt-8 hidden">No books found.</div>
            </div>

            <div id="add-book-section" class="tab-content-section hidden">
                <h2 class="text-2xl font-semibold mb-4 text-center">Add/Edit Book</h2>
                <div id="add-book-message" class="message hidden"></div>
                <form id="add-book-form">
                    <input type="hidden" id="book-id">
                    <input type="text" id="book-title" placeholder="Title" required>
                    <input type="text" id="book-author" placeholder="Author" required>
                    <input type="text" id="book-isbn" placeholder="ISBN (optional)">
                    <textarea id="book-description" placeholder="Description (optional)" rows="3"></textarea>
                    <button type="submit" id="add-book-submit-btn">Add Book</button>
                    <button type="button" id="cancel-edit-btn" class="hidden bg-gray-600 hover:bg-gray-700 ml-2">Cancel Edit</button>
                </form>
            </div>

            <div id="profile-section" class="tab-content-section hidden">
                <h2 class="text-2xl font-semibold mb-4 text-center">My Profile</h2>
                <p id="current-display-name">Current Display Name: Loading...</p>
                <form id="display-name-form">
                    <input type="text" id="new-display-name" placeholder="Enter your display name" required>
                    <button type="submit">Set Display Name</button>
                </form>
                <div id="profile-message" class="message hidden"></div>
            </div>

            <div id="users-section" class="tab-content-section hidden">
                <h2 class="text-2xl font-semibold mb-4 text-center">User Management</h2>
                <div id="user-list">
                    </div>
                <div id="user-message" class="message hidden"></div>
            </div>

        </div>

        <div id="loader-view" class="flex justify-center items-center h-screen hidden">
            <div class="loader"></div>
        </div>
    </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // Initialize Supabase - REPLACE WITH YOUR ACTUAL KEYS
        const SUPABASE_URL = 'https://nhoozjzvkydxwlrshqis.supabase.co'; // Replace with your Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5ob296anp2a3lkeHdscnNocWlzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NzMyNDEsImV4cCI6MjA2NjM0OTI0MX0.5PfsT7CBIBOIziR8k0FsMPZzW0z7EzVrzFaWvhOIK9M'; // Replace with your Supabase Anon Key

        // --- DANGER: FOR DEBUGGING ONLY ---
        // localStorage.clear(); // Uncomment this line if you need to clear local storage for testing purposes
        // --- REMOVE IN PRODUCTION ---

        const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // DOM Elements
        const authView = document.getElementById('auth-view');
        const mainView = document.getElementById('main-view');
        const loaderView = document.getElementById('loader-view');

        const authMessage = document.getElementById('auth-message');
        const signupForm = document.getElementById('signup-form');
        const signinForm = document.getElementById('signin-form');

        const displayNameHeader = document.getElementById('display-name-header');
        const themeToggle = document.getElementById('theme-toggle');
        const signoutButton = document.getElementById('signout-button');

        // Tab Navigation Elements
        const mainTabNav = document.getElementById('main-tab-nav');
        const tabMyBooks = document.getElementById('tab-my-books');
        const tabAddBook = document.getElementById('tab-add-book');
        const tabMyProfile = document.getElementById('tab-my-profile');
        const tabUsers = document.getElementById('tab-users');

        // Content Sections
        const booksSection = document.getElementById('books-section');
        const addBookSection = document.getElementById('add-book-section');
        const profileSection = document.getElementById('profile-section');
        const usersSection = document.getElementById('users-section');

        // Book related elements
        const bookListDiv = document.getElementById('book-list');
        const noBooksMessage = document.getElementById('no-books-message');
        const searchInput = document.getElementById('search-input');
        const addBookForm = document.getElementById('add-book-form');
        const bookIdInput = document.getElementById('book-id');
        const bookTitleInput = document.getElementById('book-title');
        const bookAuthorInput = document.getElementById('book-author');
        const bookIsbnInput = document.getElementById('book-isbn');
        const bookDescriptionInput = document.getElementById('book-description');
        const addBookSubmitBtn = document.getElementById('add-book-submit-btn');
        const cancelEditBtn = document.getElementById('cancel-edit-btn');
        const addBookMessage = document.getElementById('add-book-message');

        // Profile related elements
        const displayNameForm = document.getElementById('display-name-form');
        const newDisplayNameInput = document.getElementById('new-display-name');
        const currentDisplayName = document.getElementById('current-display-name');
        const profileMessage = document.getElementById('profile-message');

        // User management elements
        const userListDiv = document.getElementById('user-list');
        const userMessage = document.getElementById('user-message');

        let currentUser = null;
        let isAdmin = false;
        let books = []; // Cache for books

        // --- UI Utility Functions ---

        function showMessage(element, msg, type) {
            element.textContent = msg;
            element.className = `message ${type}`;
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        function showLoader() {
            authView.classList.add('hidden');
            mainView.classList.add('hidden');
            loaderView.classList.remove('hidden');
        }

        function hideLoader() {
            loaderView.classList.add('hidden');
        }

        function renderView(view) {
            hideLoader();
            if (view === 'auth') {
                authView.classList.remove('hidden');
                mainView.classList.add('hidden');
            } else if (view === 'main') {
                authView.classList.add('hidden');
                mainView.classList.remove('hidden');
                updateDisplayNameHeader();
                applyTheme(localStorage.getItem('theme') || 'dark-theme'); // Re-apply theme on view switch
                updateTabVisibility(); // Show/hide admin tabs
                switchTab('books-section'); // Default to My Books tab
            }
        }

        function applyTheme(theme) {
            document.body.className = theme;
            localStorage.setItem('theme', theme);
        }

        // --- Tab Switching Logic ---
        function switchTab(tabId) {
            // Hide all content sections
            booksSection.classList.add('hidden');
            addBookSection.classList.add('hidden');
            profileSection.classList.add('hidden');
            usersSection.classList.add('hidden');

            // Remove active class from all tab buttons
            document.querySelectorAll('.tab-nav button').forEach(button => {
                button.classList.remove('active');
            });

            // Show the selected section and activate its button
            document.getElementById(tabId).classList.remove('hidden');
            document.querySelector(`.tab-nav button[data-tab="${tabId}"]`).classList.add('active');

            // Load content specific to the tab if needed
            if (tabId === 'books-section') {
                fetchBooks();
            } else if (tabId === 'users-section') {
                if (isAdmin) fetchUsers();
            } else if (tabId === 'profile-section') {
                updateCurrentDisplayName();
            }
            // Add book section doesn't need to fetch anything on display
        }

        function updateTabVisibility() {
            if (isAdmin) {
                tabAddBook.classList.remove('hidden');
                tabUsers.classList.remove('hidden');
            } else {
                tabAddBook.classList.add('hidden');
                tabUsers.classList.add('hidden');
            }
        }

        // --- Authentication ---

        async function handleAuthChange(event) {
            const { session, error } = event.data.session ? event.data : { session: null, error: null }; // Handle initial load event structure
            console.log('Auth state changed:', session, error);

            if (error) {
                console.error('Auth change error:', error.message);
                showMessage(authMessage, error.message, 'error');
                currentUser = null;
                isAdmin = false;
                renderView('auth');
                return;
            }

            currentUser = session?.user || null;
            if (currentUser) {
                await checkUserAdminStatus(currentUser.id);
                renderView('main');
            } else {
                isAdmin = false;
                renderView('auth');
            }
        }

        // Listen for auth state changes
        supabase.auth.onAuthStateChange(handleAuthChange);

        // Initial check on page load
        async function initialAuthCheck() {
            showLoader();
            const { data: { session }, error } = await supabase.auth.getSession();
            if (error) {
                console.error('Initial session check error:', error.message);
                showMessage(authMessage, error.message, 'error');
                renderView('auth');
                return;
            }
            handleAuthChange({ data: { session } });
        }

        // Sign Up
        signupForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target['signup-email'].value;
            const password = e.target['signup-password'].value;
            showLoader();
            const { error } = await supabase.auth.signUp({ email, password });
            hideLoader();
            if (error) {
                showMessage(authMessage, error.message, 'error');
            } else {
                showMessage(authMessage, 'Sign-up successful! Check your email for confirmation.', 'success');
                signupForm.reset();
            }
        });

        // Sign In
        signinForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = e.target['signin-email'].value;
            const password = e.target['signin-password'].value;
            showLoader();
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            hideLoader();
            if (error) {
                showMessage(authMessage, error.message, 'error');
            } else {
                // Auth state change listener handles rendering main view
            }
        });

        // Sign Out
        signoutButton.addEventListener('click', async () => {
            showLoader();
            const { error } = await supabase.auth.signOut();
            hideLoader();
            if (error) {
                showMessage(authMessage, error.message, 'error');
            } else {
                currentUser = null;
                isAdmin = false;
                renderView('auth');
                showMessage(authMessage, 'You have been signed out.', 'success');
            }
        });

        // --- User Profile & Display Name ---

        async function updateDisplayNameHeader() {
            if (currentUser) {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('display_name')
                    .eq('id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') { // PGRST116 means no row found
                    console.error('Error fetching display name:', error);
                    displayNameHeader.textContent = `Welcome, ${currentUser.email}!`;
                } else if (data?.display_name) {
                    displayNameHeader.textContent = `Welcome, ${data.display_name}!`;
                } else {
                    displayNameHeader.textContent = `Welcome, ${currentUser.email || 'User'}!`;
                }
            } else {
                displayNameHeader.textContent = `Welcome!`;
            }
        }

        async function updateCurrentDisplayName() {
            if (currentUser) {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('display_name')
                    .eq('id', currentUser.id)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    console.error('Error fetching display name:', error);
                    currentDisplayName.textContent = `Current Display Name: Error fetching`;
                } else if (data?.display_name) {
                    currentDisplayName.textContent = `Current Display Name: ${data.display_name}`;
                    newDisplayNameInput.value = data.display_name; // Pre-fill input
                } else {
                    currentDisplayName.textContent = `Current Display Name: Not set`;
                    newDisplayNameInput.value = ''; // Clear input
                }
            }
        }

        displayNameForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!currentUser) {
                showMessage(profileMessage, 'You must be logged in to set a display name.', 'error');
                return;
            }

            const newName = newDisplayNameInput.value.trim();
            if (!newName) {
                showMessage(profileMessage, 'Display name cannot be empty.', 'error');
                return;
            }

            const { error } = await supabase
                .from('profiles')
                .upsert({ id: currentUser.id, display_name: newName }, { onConflict: 'id' });

            if (error) {
                console.error('Error setting display name:', error);
                showMessage(profileMessage, `Error setting display name: ${error.message}`, 'error');
            } else {
                showMessage(profileMessage, 'Display name updated successfully!', 'success');
                updateDisplayNameHeader();
                updateCurrentDisplayName();
            }
        });

        // --- Admin Role Check ---

        async function checkUserAdminStatus(userId) {
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('is_admin')
                    .eq('id', userId)
                    .single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }
                isAdmin = data?.is_admin || false;
            } catch (error) {
                console.error('Error checking admin status:', error.message);
                isAdmin = false;
            }
            updateTabVisibility(); // Update tab visibility after checking admin status
        }

        // --- Theme Toggle ---

        themeToggle.addEventListener('click', () => {
            const currentTheme = document.body.className;
            const newTheme = currentTheme === 'dark-theme' ? 'light-theme' : 'dark-theme';
            applyTheme(newTheme);
        });

        // --- Books Management ---

        async function fetchBooks(searchTerm = '') {
            showLoader();
            let query = supabase
                .from('books')
                .select('*')
                .order('title', { ascending: true });

            if (searchTerm) {
                query = query.or(`title.ilike.%${searchTerm}%,author.ilike.%${searchTerm}%`);
            }

            const { data, error } = await query;
            hideLoader();
            if (error) {
                console.error('Error fetching books:', error);
                bookListDiv.innerHTML = `<p class="text-center text-red-500">Error loading books: ${error.message}</p>`;
                noBooksMessage.classList.add('hidden');
                return;
            }
            books = data; // Cache the fetched books
            renderBookList();
        }

        function renderBookList() {
            bookListDiv.innerHTML = '';
            if (books.length === 0) {
                noBooksMessage.classList.remove('hidden');
                return;
            }
            noBooksMessage.classList.add('hidden');

            books.forEach(book => {
                const bookItem = document.createElement('div');
                bookItem.className = 'book-item';
                const isBorrowed = book.borrowed_by !== null;
                const isBorrowedByCurrentUser = isBorrowed && book.borrowed_by === currentUser?.id;
                const canBorrow = !isBorrowed && currentUser;
                const canReturn = isBorrowedByCurrentUser;

                bookItem.innerHTML = `
                    <div class="book-details">
                        <h3 class="text-xl font-semibold">${book.title}</h3>
                        <p class="text-gray-400">by ${book.author}</p>
                        ${book.isbn ? `<p class="text-gray-500 text-sm">ISBN: ${book.isbn}</p>` : ''}
                        ${book.description ? `<p class="text-gray-300 mt-2 text-sm">${book.description}</p>` : ''}
                        <p class="mt-2 text-sm ${isBorrowed ? 'text-red-400 font-bold' : 'text-green-400'}">
                            Status: ${isBorrowed ? `Borrowed by ${book.borrower_display_name || 'another user'}` : 'Available'}
                        </p>
                    </div>
                    <div class="actions mt-4 flex flex-wrap gap-2">
                        ${canBorrow ? `<button class="borrow-btn bg-blue-600 hover:bg-blue-700 text-white" data-id="${book.id}">Borrow</button>` : ''}
                        ${canReturn ? `<button class="return-btn bg-green-600 hover:bg-green-700 text-white" data-id="${book.id}">Return</button>` : ''}
                        ${isAdmin ? `<button class="edit-btn bg-yellow-600 hover:bg-yellow-700 text-white" data-id="${book.id}">Edit</button>` : ''}
                        ${isAdmin ? `<button class="delete-btn bg-red-600 hover:bg-red-700 text-white" data-id="${book.id}">Delete</button>` : ''}
                    </div>
                `;
                bookListDiv.appendChild(bookItem);
            });
        }

        // Add/Edit Book
        addBookForm.addEventListener('submit', handleAddUpdateBook);
        cancelEditBtn.addEventListener('click', resetAddBookForm);

        async function handleAddUpdateBook(e) {
            e.preventDefault();
            if (!isAdmin) {
                showMessage(addBookMessage, 'You do not have permission to add/edit books.', 'error');
                return;
            }

            const id = bookIdInput.value;
            const title = bookTitleInput.value.trim();
            const author = bookAuthorInput.value.trim();
            const isbn = bookIsbnInput.value.trim();
            const description = bookDescriptionInput.value.trim();

            if (!title || !author) {
                showMessage(addBookMessage, 'Title and Author are required.', 'error');
                return;
            }

            showLoader();
            let error = null;
            if (id) {
                // Update existing book
                const { error: updateError } = await supabase
                    .from('books')
                    .update({ title, author, isbn: isbn || null, description: description || null })
                    .eq('id', id);
                error = updateError;
            } else {
                // Add new book
                const { error: insertError } = await supabase
                    .from('books')
                    .insert({ title, author, isbn: isbn || null, description: description || null });
                error = insertError;
            }
            hideLoader();

            if (error) {
                console.error('Error adding/updating book:', error);
                showMessage(addBookMessage, `Error: ${error.message}`, 'error');
            } else {
                showMessage(addBookMessage, `Book ${id ? 'updated' : 'added'} successfully!`, 'success');
                resetAddBookForm();
                fetchBooks(); // Refresh book list
            }
        }

        function resetAddBookForm() {
            addBookForm.reset();
            bookIdInput.value = '';
            addBookSubmitBtn.textContent = 'Add Book';
            cancelEditBtn.classList.add('hidden');
            addBookMessage.classList.add('hidden'); // Clear message
        }

        bookListDiv.addEventListener('click', async (e) => {
            const target = e.target;
            const bookId = target.dataset.id;

            if (target.classList.contains('borrow-btn')) {
                if (!currentUser) {
                    showMessage(booksSection.querySelector('.message') || bookListDiv, 'You must be logged in to borrow books.', 'error'); // More specific message placement
                    return;
                }
                const { error } = await supabase
                    .from('books')
                    .update({ borrowed_by: currentUser.id, borrower_display_name: localStorage.getItem('display_name') || currentUser.email })
                    .eq('id', bookId)
                    .is('borrowed_by', null); // Only update if not already borrowed

                if (error) {
                    console.error('Error borrowing book:', error);
                    showMessage(booksSection.querySelector('.message') || bookListDiv, `Error borrowing book: ${error.message}`, 'error');
                } else {
                    showMessage(booksSection.querySelector('.message') || bookListDiv, 'Book borrowed successfully!', 'success');
                    fetchBooks();
                }
            } else if (target.classList.contains('return-btn')) {
                if (!currentUser) return; // Should not happen if button isn't shown
                const { error } = await supabase
                    .from('books')
                    .update({ borrowed_by: null, borrower_display_name: null })
                    .eq('id', bookId)
                    .eq('borrowed_by', currentUser.id); // Only allow current user to return their own book

                if (error) {
                    console.error('Error returning book:', error);
                    showMessage(booksSection.querySelector('.message') || bookListDiv, `Error returning book: ${error.message}`, 'error');
                } else {
                    showMessage(booksSection.querySelector('.message') || bookListDiv, 'Book returned successfully!', 'success');
                    fetchBooks();
                }
            } else if (target.classList.contains('edit-btn')) {
                if (!isAdmin) return;
                const bookToEdit = books.find(book => book.id === bookId);
                if (bookToEdit) {
                    bookIdInput.value = bookToEdit.id;
                    bookTitleInput.value = bookToEdit.title;
                    bookAuthorInput.value = bookToEdit.author;
                    bookIsbnInput.value = bookToEdit.isbn || '';
                    bookDescriptionInput.value = bookToEdit.description || '';
                    addBookSubmitBtn.textContent = 'Update Book';
                    cancelEditBtn.classList.remove('hidden');
                    switchTab('add-book-section'); // Switch to Add Book tab for editing
                }
            } else if (target.classList.contains('delete-btn')) {
                if (!isAdmin) return;
                if (confirm('Are you sure you want to delete this book?')) {
                    showLoader();
                    const { error } = await supabase
                        .from('books')
                        .delete()
                        .eq('id', bookId);
                    hideLoader();
                    if (error) {
                        console.error('Error deleting book:', error);
                        showMessage(booksSection.querySelector('.message') || bookListDiv, `Error deleting book: ${error.message}`, 'error');
                    } else {
                        showMessage(booksSection.querySelector('.message') || bookListDiv, 'Book deleted successfully!', 'success');
                        fetchBooks();
                    }
                }
            }
        });

        // Search functionality
        searchInput.addEventListener('input', () => {
            const searchTerm = searchInput.value.trim();
            fetchBooks(searchTerm);
        });

        // --- User Management (Admin only) ---

        async function fetchUsers() {
            if (!isAdmin) {
                userListDiv.innerHTML = '<p class="text-center text-red-500">You do not have permission to view users.</p>';
                return;
            }
            showLoader();
            const { data: users, error } = await supabase
                .from('profiles')
                .select('*')
                .order('display_name', { ascending: true });
            hideLoader();

            if (error) {
                console.error('Error fetching users:', error);
                userListDiv.innerHTML = `<p class="text-center text-red-500">Error loading users: ${error.message}</p>`;
                return;
            }

            renderUserList(users);
        }

        function renderUserList(users) {
            userListDiv.innerHTML = '';
            if (users.length === 0) {
                userListDiv.innerHTML = '<p class="text-center text-gray-500">No users found.</p>';
                return;
            }

            users.forEach(user => {
                const userItem = document.createElement('div');
                userItem.className = 'user-item';
                userItem.innerHTML = `
                    <span>${user.display_name || user.id} (Admin: ${user.is_admin ? 'Yes' : 'No'})</span>
                    <div class="actions">
                        ${user.id !== currentUser.id ? `
                            ${user.is_admin ?
                                `<button class="toggle-admin-btn bg-red-600 hover:bg-red-700" data-id="${user.id}" data-is-admin="true">Revoke Admin</button>` :
                                `<button class="toggle-admin-btn bg-green-600 hover:bg-green-700" data-id="${user.id}" data-is-admin="false">Make Admin</button>`
                            }
                            <button class="delete-user-btn bg-red-800 hover:bg-red-900 ml-2" data-id="${user.id}">Delete User</button>
                        ` : '<span class="text-gray-500"> (You)</span>'}
                    </div>
                `;
                userListDiv.appendChild(userItem);
            });
        }

        userListDiv.addEventListener('click', async (e) => {
            const target = e.target;
            const userId = target.dataset.id;

            if (!isAdmin) {
                showMessage(userMessage, 'You do not have permission for user management.', 'error');
                return;
            }

            if (target.classList.contains('toggle-admin-btn')) {
                const currentAdminStatus = target.dataset.isAdmin === 'true';
                const newAdminStatus = !currentAdminStatus;
                if (confirm(`Are you sure you want to ${newAdminStatus ? 'grant' : 'revoke'} admin privileges for this user?`)) {
                    showLoader();
                    const { error } = await supabase
                        .from('profiles')
                        .update({ is_admin: newAdminStatus })
                        .eq('id', userId);
                    hideLoader();
                    if (error) {
                        console.error('Error toggling admin status:', error);
                        showMessage(userMessage, `Error: ${error.message}`, 'error');
                    } else {
                        showMessage(userMessage, 'Admin status updated!', 'success');
                        fetchUsers(); // Refresh user list
                    }
                }
            } else if (target.classList.contains('delete-user-btn')) {
                if (confirm('Are you sure you want to delete this user? This action cannot be undone.')) {
                    showLoader();
                    const { error: authError } = await supabase.rpc('delete_user_by_id', { user_id_to_delete: userId });
                    hideLoader();
                    if (authError) {
                        console.error('Error deleting user:', authError);
                        showMessage(userMessage, `Error deleting user: ${authError.message}`, 'error');
                    } else {
                        showMessage(userMessage, 'User deleted successfully!', 'success');
                        fetchUsers(); // Refresh user list
                    }
                }
            }
        });

        // --- Event Listeners for Tabs ---
        mainTabNav.addEventListener('click', (e) => {
            if (e.target.tagName === 'BUTTON') {
                const tabId = e.target.dataset.tab;
                if (tabId) {
                    // Only switch if the tab is not hidden (e.g., admin tabs)
                    if (!e.target.classList.contains('hidden')) {
                         switchTab(tabId);
                    }
                }
            }
        });


        // --- Initial Load ---
        initialAuthCheck(); // This will trigger renderView('main') or 'auth' and then switch to default tab if main
    </script>
</body>
</html>
