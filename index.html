<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Family Library</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom CSS to override/extend Tailwind for consistent theme and tab styles */
        body {
            font-family: 'Inter', sans-serif; /* Or your preferred font */
            background-color: #f3f4f6; /* light mode background */
            color: #1f2937; /* light mode text */
        }

        .light-mode {
            background-color: #f3f4f6;
            color: #1f2937;
        }

        .dark-mode {
            background-color: #111827; /* Dark background */
            color: #e5e7eb; /* Light text */
        }

        /* Specific text colors for headers in light/dark mode */
        .text-header-light { color: #4b0082; } /* Darker purple for light mode header */
        .dark-mode .text-header-light { color: #d8b4fe; } /* Lighter purple for dark mode header */

        .text-sub-header-light { color: #6b21a8; } /* Medium purple for light mode sub-headers */
        .dark-mode .text-sub-header-light { color: #a78bfa; } /* Lighter purple for dark mode sub-headers */


        /* Button base styles */
        .btn-primary {
            background-color: #8b5cf6; /* purple-500 */
            color: white;
            border: 1px solid #8b5cf6;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .btn-primary:hover {
            background-color: #7c3aed; /* purple-600 */
            border-color: #7c3aed;
        }

        .btn-secondary {
            background-color: #e5e7eb; /* gray-200 */
            color: #4b5563; /* gray-700 */
            border: 1px solid #e5e7eb;
            transition: background-color 0.2s ease-in-out, color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .btn-secondary:hover {
            background-color: #d1d5db; /* gray-300 */
            border-color: #d1d5db;
        }

        .btn-purple {
            background-color: #a78bfa; /* purple-400 */
            color: white;
            border: 1px solid #a78bfa;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .btn-purple:hover {
            background-color: #8b5cf6; /* purple-500 */
            border-color: #8b5cf6;
        }

        .btn-blue {
            background-color: #60a5fa; /* blue-400 */
            color: white;
            border: 1px solid #60a5fa;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .btn-blue:hover {
            background-color: #3b82f6; /* blue-500 */
            border-color: #3b82f6;
        }

        .btn-red {
            background-color: #ef4444; /* red-500 */
            color: white;
            border: 1px solid #ef4444;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .btn-red:hover {
            background-color: #dc2626; /* red-600 */
            border-color: #dc2626;
        }

        .btn-green {
            background-color: #34d399; /* green-500 */
            color: white;
            border: 1px solid #34d399;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .btn-green:hover {
            background-color: #10b981; /* green-600 */
            border-color: #10b981;
        }

        .btn-yellow {
            background-color: #facc15; /* yellow-400 */
            color: #4b5563; /* gray-700 */
            border: 1px solid #facc15;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .btn-yellow:hover {
            background-color: #eab308; /* yellow-500 */
            border-color: #eab308;
        }

        /* Dark Mode Button Overrides */
        .dark-mode .btn-primary {
            background-color: #8b5cf6; /* dark:bg-purple-600 */
            border-color: #8b5cf6;
        }
        .dark-mode .btn-primary:hover {
            background-color: #7c3aed; /* dark:hover:bg-purple-700 */
        }

        .dark-mode .btn-secondary {
            background-color: #4b5563; /* dark:bg-gray-600 */
            color: #e5e7eb; /* dark:text-gray-200 */
            border-color: #4b5563;
        }
        .dark-mode .btn-secondary:hover {
            background-color: #374151; /* dark:hover:bg-gray-700 */
            border-color: #374151;
        }

        .dark-mode .btn-purple {
            background-color: #a78bfa; /* dark:bg-purple-400 */
            border-color: #a78bfa;
        }
        .dark-mode .btn-purple:hover {
            background-color: #8b5cf6; /* dark:hover:bg-purple-500 */
            border-color: #8b5cf6;
        }

        .dark-mode .btn-blue {
            background-color: #60a5fa; /* dark:bg-blue-400 */
            border-color: #60a5fa;
        }
        .dark-mode .btn-blue:hover {
            background-color: #3b82f6; /* dark:hover:bg-blue-500 */
            border-color: #3b82f6;
        }

        .dark-mode .btn-red {
            background-color: #ef4444; /* dark:bg-red-500 */
            border-color: #ef4444;
        }
        .dark-mode .btn-red:hover {
            background-color: #dc2626; /* dark:hover:bg-red-600 */
            border-color: #dc2626;
        }

        .dark-mode .btn-green {
            background-color: #34d399; /* dark:bg-green-400 */
            border-color: #34d399;
        }
        .dark-mode .btn-green:hover {
            background-color: #10b981; /* dark:hover:bg-green-500 */
            border-color: #10b981;
        }

        .dark-mode .btn-yellow {
            background-color: #facc15; /* dark:bg-yellow-400 */
            color: #374151; /* dark:text-gray-700 */
            border-color: #facc15;
        }
        .dark-mode .btn-yellow:hover {
            background-color: #eab308; /* dark:hover:bg-yellow-500 */
            border-color: #eab308;
        }

        /* Input field dark mode styles */
        .dark-mode input[type="text"],
        .dark-mode input[type="email"],
        .dark-mode input[type="password"] {
            background-color: #374151; /* gray-700 */
            color: #e5e7eb; /* gray-200 */
            border-color: #4b5563; /* gray-600 */
        }
        .dark-mode input[type="text"]:focus,
        .dark-mode input[type="email"]:focus,
        .dark-mode input[type="password"]:focus {
            border-color: #a78bfa; /* purple-400 */
            box-shadow: 0 0 0 1px #a78bfa;
        }

        /* Specific dark mode adjustments for general elements */
        .dark-mode .bg-white {
            background-color: #1f2937; /* dark:bg-gray-800 */
        }
        .dark-mode .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.3), 0 4px 6px -2px rgba(0, 0, 0, 0.05); /* Darker shadow */
        }
        .dark-mode .bg-gray-50 {
            background-color: #374151; /* dark:bg-gray-700 */
        }
        .dark-mode .border-gray-200 {
            border-color: #4b5563; /* dark:border-gray-600 */
        }
        .dark-mode .text-gray-800 {
            color: #e5e7eb; /* dark:text-gray-200 */
        }
        .dark-mode .text-gray-700 {
            color: #d1d5db; /* dark:text-gray-300 */
        }
        .dark-mode .text-gray-600 {
            color: #9ca3af; /* dark:text-gray-400 */
        }
        .dark-mode .text-gray-900 {
            color: #f3f4f6; /* dark:text-gray-50 */
        }
        .dark-mode .text-yellow-700 {
            color: #fcd34d; /* yellow-300 for dark mode */
        }
        .dark-mode .text-green-700 {
            color: #6ee7b7; /* green-300 for dark mode */
        }
        .dark-mode .book-list-item {
             border-color: #4b5563; /* dark:border-gray-600 */
        }

        /* Tab specific styles for Google Tabs look */
        .tab-container {
            display: flex;
            margin-bottom: 1.5rem;
            border-bottom: 2px solid #e5e7eb; /* Light mode border */
        }
        .dark-mode .tab-container {
            border-bottom-color: #4b5563; /* Dark mode border */
        }

        .tab-button {
            padding: 0.75rem 1.25rem;
            font-weight: 500;
            color: #4b5563; /* Light mode default text */
            cursor: pointer;
            border: none;
            background-color: transparent;
            transition: all 0.2s ease-in-out;
            position: relative;
            outline: none; /* Remove default focus outline */
        }
        .tab-button:hover {
            color: #6d28d9; /* Light mode hover text */
        }
        .tab-button.active {
            color: #6d28d9; /* Light mode active text */
            font-weight: 600;
        }
        .tab-button.active::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 100%;
            height: 2px;
            background-color: #6d28d9; /* Light mode active indicator */
        }

        /* Dark mode for tab buttons */
        .dark-mode .tab-button {
            color: #9ca3af; /* dark:text-gray-400 */
        }
        .dark-mode .tab-button:hover {
            color: #a78bfa; /* dark:hover:text-purple-300 */
        }
        .dark-mode .tab-button.active {
            color: #a78bfa; /* dark:text-purple-300 */
        }
        .dark-mode .tab-button.active::after {
            background-color: #a78bfa; /* dark:border-purple-300 */
        }

        .tab-content-panel {
            display: none;
        }
        .tab-content-panel.active {
            display: block;
        }
    </style>
</head>
<body>
    <div id="app">
        </div>

    <script type="module">
        import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

        // --- Supabase Client Initialization ---
        const SUPABASE_URL = 'https://nhoozjzvkydxwlrshqis.supabase.co'; // Your Supabase URL
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFiY2RlLTEyMzQ1Iiwicm9sZSI6ImFub24iLCJpYXQiOjExMTExMTExMTYsImV4cCI6MTgyOTY3Nzc2MH0.fghij-klmnop_qrst-uvwxyzabcdef'; // Your Supabase Anon Key

        let supabase = null; // Initialize as null
        let userId = null;
        let userEmail = null;
        let isAdmin = false; // Flag to check if the user is an admin
        let userProfiles = {}; // Map to store display names by user_id
        let books = []; // Array to store fetched books
        let editingBook = null; // To store the book being edited
        const appDiv = document.getElementById('app');

        // Function to initialize Supabase and fetch user profiles/session
        async function initializeSupabase() {
            try {
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                console.log("Supabase client initialized.");

                // Fetch existing profiles to populate userProfiles map
                await fetchUserProfiles();

                // Listen for auth state changes
                supabase.auth.onAuthStateChange(async (event, session) => {
                    console.log('Auth state changed:', event, session);
                    if (session) {
                        userId = session.user.id;
                        userEmail = session.user.email;
                        await fetchUserProfiles(); // Re-fetch profiles on auth change to ensure up-to-date display names
                        await checkAdminStatus(userId); // Check admin status on login
                        renderView('main');
                        setupRealtimeBooksListener(); // Set up real-time listener only when logged in
                    } else {
                        userId = null;
                        userEmail = null;
                        isAdmin = false; // Reset admin status on logout
                        books = []; // Clear books on logout
                        userProfiles = {}; // Clear profiles on logout
                        supabase.removeAllChannels(); // Stop real-time listeners on logout
                        renderView('auth');
                    }
                });

                // Get initial session
                const { data: { session } } = await supabase.auth.getSession();
                if (session) {
                    userId = session.user.id;
                    userEmail = session.user.email;
                    await fetchUserProfiles();
                    await checkAdminStatus(userId);
                    renderView('main');
                    setupRealtimeBooksListener();
                } else {
                    renderView('auth');
                }

            } catch (error) {
                console.error("Error initializing Supabase:", error);
                alert("Failed to initialize Supabase. Please check your URL and ANON key.");
                renderView('auth'); // Fallback to auth view on initialization error
            }
        }

        // --- Admin Status Check ---
        async function checkAdminStatus(id) {
            if (!supabase) return;
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('is_admin')
                    .eq('user_id', id)
                    .single();

                if (error && error.details.includes('0 rows')) {
                    // Profile might not exist yet, treat as not admin
                    isAdmin = false;
                    console.log("User profile not found or not admin.");
                } else if (error) {
                    throw error;
                } else {
                    isAdmin = data ? data.is_admin : false;
                    console.log("Admin status:", isAdmin);
                }
            } catch (error) {
                console.error("Error checking admin status:", error);
                isAdmin = false; // Default to not admin on error
            }
        }

        // --- Fetch User Profiles for Display Names ---
        async function fetchUserProfiles() {
            if (!supabase) return;
            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .select('user_id, display_name');

                if (error) throw error;

                userProfiles = {}; // Clear existing profiles
                data.forEach(profile => {
                    userProfiles[profile.user_id] = profile.display_name;
                });
                console.log("User profiles fetched:", userProfiles);
            } catch (error) {
                console.error("Error fetching user profiles:", error);
            }
        }

        function updateUserInfoDisplay() {
            const userNameSpan = document.querySelector('.text-purple-700');
            if (userNameSpan) {
                userNameSpan.textContent = userProfiles[userId] || userEmail || 'Guest';
            }
        }

        // --- Render Books List ---
        function renderBookList(booksToDisplay = books) {
            const booksListElement = document.getElementById('books-list');
            const noBooksMessage = document.getElementById('no-books-message');
            const isDarkMode = document.body.classList.contains('dark-mode'); // Get dark mode status inside render function

            if (!booksListElement) {
                console.warn("Books list element not found. Skipping book list render.");
                return;
            }

            if (booksToDisplay.length === 0) {
                booksListElement.innerHTML = '';
                if (noBooksMessage) noBooksMessage.classList.remove('hidden');
            } else {
                if (noBooksMessage) noBooksMessage.classList.add('hidden');
                booksListElement.innerHTML = booksToDisplay.map(book => {
                    const isBorrowed = book.borrowed_by !== null;
                    const isBorrowedByCurrentUser = book.borrowed_by === userId;
                    const borrowerName = isBorrowed ? book.displayBorrowedBy : ''; // Use display name
                    const addedByName = book.displayAddedBy; // Use display name for added_by

                    return `
                        <div class="book-list-item bg-gray-50 p-4 rounded-lg shadow-sm flex flex-col sm:flex-row justify-between items-start sm:items-center border border-gray-200 ${isDarkMode ? 'dark:bg-gray-700 dark:border-gray-600' : ''}">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 ${isDarkMode ? 'dark:text-gray-50' : ''}">${book.title}</h3>
                                <p class="text-gray-600 text-sm ${isDarkMode ? 'dark:text-gray-400' : ''}">by ${book.author}</p>
                                <p class="text-gray-500 text-xs ${isDarkMode ? 'dark:text-gray-400' : ''}">Added by: ${addedByName}</p>
                                ${isBorrowed ?
                                    `<p class="text-sm text-yellow-700 mt-1 ${isDarkMode ? 'dark:text-yellow-300' : ''}">Borrowed by: ${borrowerName}</p>` :
                                    `<p class="text-sm text-green-700 mt-1 ${isDarkMode ? 'dark:text-green-300' : ''}">Available</p>`
                                }
                            </div>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-2 mt-3 sm:mt-0">
                                ${isAdmin ? `
                                    <button data-id="${book.id}" class="btn-blue text-sm py-1 px-3 rounded-md edit-btn">Edit</button>
                                    <button data-id="${book.id}" class="btn-red text-sm py-1 px-3 rounded-md delete-btn">Delete</button>
                                ` : ''}
                                ${isBorrowed ?
                                    (isBorrowedByCurrentUser ?
                                        `<button data-id="${book.id}" data-borrowed-by="${book.borrowed_by}" class="btn-green text-sm py-1 px-3 rounded-md borrow-return-btn">Return</button>` :
                                        `<button class="btn-yellow text-sm py-1 px-3 rounded-md opacity-75 cursor-not-allowed" disabled>Borrowed</button>`)
                                    :
                                    `<button data-id="${book.id}" data-borrowed-by="${book.borrowed_by}" class="btn-yellow text-sm py-1 px-3 rounded-md borrow-return-btn">Borrow</button>`
                                }
                            </div>
                        </div>
                    `;
                }).join('');

                // Attach action listeners after rendering list items
                document.querySelectorAll('.edit-btn').forEach(button => {
                    button.addEventListener('click', () => handleEditClick(button.dataset.id));
                });
                document.querySelectorAll('.delete-btn').forEach(button => {
                    button.addEventListener('click', () => handleDeleteBook(button.dataset.id));
                });
                document.querySelectorAll('.borrow-return-btn').forEach(button => {
                    button.addEventListener('click', () => handleBorrowReturn(button.dataset.id, button.dataset.borrowedBy));
                });
            }
        }

        // --- Fetch Book Details from Supabase ---
        async function fetchAndRenderBooks() {
            if (!supabase) return;
            console.log("Fetching and rendering books...");
            try {
                const { data, error } = await supabase
                    .from('books')
                    .select(`
                        id,
                        title,
                        author,
                        isbn,
                        borrowed_by,
                        last_modified,
                        added_by
                    `);

                if (error) throw error;

                books = data.map(book => {
                    // Use userProfiles map for display names
                    let displayBorrowedBy = userProfiles[book.borrowed_by] || book.borrowed_by || 'N/A';
                    let displayAddedBy = userProfiles[book.added_by] || book.added_by || 'Unknown';

                    return {
                        ...book,
                        displayBorrowedBy: displayBorrowedBy,
                        displayAddedBy: displayAddedBy
                    };
                }).sort((a, b) => a.title.localeCompare(b.title));

                // If currently on the catalogue tab, re-render the list
                const catalogueTab = document.getElementById('tab-catalogue');
                if (catalogueTab && catalogueTab.classList.contains('active')) {
                    renderBookList(); // Rerender full list when data changes
                }
            } catch (error) {
                console.error("Error fetching books from Supabase:", error);
                alert("Error fetching books. Please check Supabase setup and RLS policies.");
            }
        }

        // --- Real-time Books Listener ---
        function setupRealtimeBooksListener() {
            if (!supabase) return;

            console.log("Setting up real-time books listener.");
            // Remove all existing channels to prevent multiple listeners
            supabase.removeAllChannels();

            supabase
                .channel('books_changes')
                .on('postgres_changes', { event: '*', schema: 'public', table: 'books' }, payload => {
                    console.log('Real-time change received!', payload);
                    fetchAndRenderBooks(); // Re-fetch all books on any change
                })
                .subscribe();

            fetchAndRenderBooks(); // Initial fetch
        }

        // --- Fetch Book Details from Google Books API by ISBN ---
        async function fetchBookDetailsByIsbn() {
            const isbnSearchInput = document.getElementById('isbn-search-input').value.trim();
            if (!isbnSearchInput) {
                alert("Please enter an ISBN.");
                return;
            }

            const apiUrl = `https://www.googleapis.com/books/v1/volumes?q=isbn:${isbnSearchInput}`;

            try {
                const response = await fetch(apiUrl);
                const data = await response.json();

                if (data.items && data.items.length > 0) {
                    const volumeInfo = data.items[0].volumeInfo;
                    document.getElementById('book-title').value = volumeInfo.title || '';
                    document.getElementById('book-author').value = volumeInfo.authors ? volumeInfo.authors.join(', ') : '';
                    document.getElementById('book-isbn').value = isbnSearchInput;
                    alert("Book details fetched successfully!");
                } else {
                    alert("No book found for this ISBN. Please enter details manually.");
                    document.getElementById('book-title').value = '';
                    document.getElementById('book-author').value = '';
                    document.getElementById('book-isbn').value = isbnSearchInput;
                }
            } catch (error) {
                console.error("Error fetching book details:", error);
                alert("Error fetching book details. Please check the ISBN or your internet connection.");
                document.getElementById('book-title').value = '';
                document.getElementById('book-author').value = '';
                document.getElementById('book-isbn').value = isbnSearchInput;
            }
        }

        // --- Add/Update Book ---
        async function handleAddUpdateBook(event) {
            event.preventDefault();

            const title = document.getElementById('book-title').value.trim();
            const author = document.getElementById('book-author').value.trim();
            const isbn = document.getElementById('book-isbn').value.trim();

            if (!title || !author) {
                alert("Book title and author cannot be empty.");
                return;
            }

            if (!supabase) {
                alert("Supabase client not initialized. Please try again.");
                return;
            }

            try {
                if (editingBook) {
                    const { data, error } = await supabase
                        .from('books')
                        .update({
                            title: title,
                            author: author,
                            isbn: isbn,
                            "last_modified": new Date().toISOString()
                        })
                        .eq('id', editingBook.id);

                    if (error) throw error;

                    alert("Book updated successfully!");
                    editingBook = null;
                    document.getElementById('add-edit-book-form').reset();
                    document.getElementById('add-edit-form-title').textContent = 'Add New Book';
                    document.getElementById('add-update-button').textContent = 'Add Book';
                    document.getElementById('cancel-edit-button').classList.add('hidden');
                    document.getElementById('isbn-search-section').classList.remove('hidden');
                } else {
                    const { data, error } = await supabase
                        .from('books')
                        .insert([
                            {
                                title: title,
                                author: author,
                                isbn: isbn,
                                "borrowed_by": null,
                                "added_by": userId
                            }
                        ]);

                    if (error) throw error;

                    alert("Book added successfully!");
                    document.getElementById('add-edit-book-form').reset();
                    document.getElementById('isbn-search-input').value = '';
                }
            } catch (e) {
                console.error("Error saving book: ", e);
                alert(`Error saving book: ${e.message}. Please check RLS policies and admin permissions.`);
            }
        }

        // --- Handle Edit Click ---
        function handleEditClick(bookId) {
            editingBook = books.find(b => b.id === bookId);
            if (editingBook) {
                // Switch to the 'Manage Books' tab
                switchTab('manage');
                document.getElementById('book-title').value = editingBook.title;
                document.getElementById('book-author').value = editingBook.author;
                document.getElementById('book-isbn').value = editingBook.isbn;

                document.getElementById('add-edit-form-title').textContent = 'Edit Book Details';
                document.getElementById('add-update-button').textContent = 'Update Book';
                document.getElementById('cancel-edit-button').classList.remove('hidden');
                document.getElementById('isbn-search-section').classList.add('hidden');
            }
        }

        // --- Handle Cancel Edit ---
        function handleCancelEdit() {
            editingBook = null;
            document.getElementById('add-edit-book-form').reset();
            document.getElementById('add-edit-form-title').textContent = 'Add New Book';
            document.getElementById('add-update-button').textContent = 'Add Book';
            document.getElementById('cancel-edit-button').classList.add('hidden');
            document.getElementById('isbn-search-section').classList.remove('hidden');
        }

        // --- Handle Borrow/Return ---
        async function handleBorrowReturn(bookId, currentBorrowedByUid) {
            if (!supabase || !userId) {
                alert("You must be logged in to borrow or return books.");
                return;
            }

            let message = '';
            let newBorrowedByValue = null;

            if (currentBorrowedByUid && currentBorrowedByUid !== 'null') {
                if (currentBorrowedByUid === userId) {
                    newBorrowedByValue = null;
                    message = "Book returned successfully!";
                } else {
                    alert("This book is borrowed by another user. Only the borrower can return it.");
                    return;
                }
            } else {
                newBorrowedByValue = userId;
                message = `Book borrowed by you!`;
            }

            try {
                const { data, error } = await supabase
                    .from('books')
                    .update({
                        "borrowed_by": newBorrowedByValue,
                        "last_modified": new Date().toISOString()
                    })
                    .eq('id', bookId);

                if (error) throw error;
                alert(message);
            } catch (e) {
                console.error("Error updating borrow status: ", e);
                alert(`Error updating borrow status: ${e.message}. Please check RLS policies.`);
            }
        }

        // --- Handle Delete Book ---
        async function handleDeleteBook(bookId) {
            if (!supabase) {
                alert("Supabase client not initialized. Please try again.");
                return;
            }

            if (!isAdmin) {
                alert("Only administrators can delete books.");
                return;
            }

            const confirmDelete = confirm("Are you sure you want to delete this book?");
            if (confirmDelete) {
                try {
                    const { error } = await supabase
                        .from('books')
                        .delete()
                        .eq('id', bookId);

                    if (error) throw error;
                    alert("Book deleted successfully!");
                } catch (e) {
                    console.error("Error deleting document: ", e);
                    alert(`Error deleting book: ${e.message}. Please check RLS policies.`);
                }
            } else {
                alert("Delete action cancelled.");
            }
        }

        // --- Authentication Functions ---
        async function handleAuth(event, isSignUp) {
            event.preventDefault();
            const email = document.getElementById('auth-email').value.trim();
            const password = document.getElementById('auth-password').value.trim();

            if (!email || !password) {
                alert("Email and password cannot be empty.");
                return;
            }

            if (!supabase) {
                alert("Supabase client not initialized. Please try again.");
                return;
            }

            try {
                let response;
                if (isSignUp) {
                    response = await supabase.auth.signUp({ email, password });
                    if (response.error) {
                        throw response.error;
                    }
                    if (response.data.user) {
                        alert("Sign up successful and logged in! You can now set your display name.");
                    } else {
                        // This case is for when email confirmation is required but no auto-login happens
                        alert("Sign up successful! Please check your email to confirm your account.");
                    }
                } else { // is login
                    response = await supabase.auth.signInWithPassword({ email, password });
                    if (response.error) {
                        throw response.error;
                    }
                    alert("Login successful!");
                }
                // onAuthStateChange listener will now handle renderView('main') on success
            } catch (error) {
                console.error("Auth error:", error);
                alert(`Authentication failed: ${error.message}`);
            }
        }

        async function handleLogout() {
            if (!supabase) return;
            try {
                const { error } = await supabase.auth.signOut();
                if (error) throw error;
                alert("You have been logged out.");
                // Auth state change listener will handle view rendering
            } catch (error) {
                console.error("Logout error:", error);
                alert(`Logout failed: ${error.message}`);
            }
        }

        // --- Profile Management ---
        async function handleSetDisplayName(event) {
            event.preventDefault();
            const newDisplayName = document.getElementById('display-name-input').value.trim();

            if (!newDisplayName) {
                alert("Display name cannot be empty.");
                return;
            }
            if (!userId) {
                alert("You must be logged in to set a display name.");
                return;
            }

            try {
                const { data, error } = await supabase
                    .from('profiles')
                    .upsert({ user_id: userId, display_name: newDisplayName }, { onConflict: 'user_id' })
                    .select(); // Use select() to get the updated data back

                if (error) throw error;

                // Update the local userProfiles map and re-render UI
                userProfiles[userId] = newDisplayName;
                alert("Display name updated successfully!");
                updateUserInfoDisplay(); // Update header
                renderBookList(); // Update book list to show new name
            } catch (error) {
                console.error("Error setting display name:", error);
                alert(`Failed to set display name: ${error.message}`);
            }
        }


        // --- Tab Switching Logic ---
        function switchTab(tabId) {
            // Remove active class from all buttons and panels
            document.querySelectorAll('.tab-button').forEach(button => button.classList.remove('active'));
            document.querySelectorAll('.tab-content-panel').forEach(panel => panel.classList.remove('active'));

            // Add active class to the clicked button and its corresponding panel
            const activeButton = document.querySelector(`.tab-button[data-tab="${tabId}"]`);
            const activePanel = document.getElementById(`tab-${tabId}`);

            if (activeButton) activeButton.classList.add('active');
            if (activePanel) activePanel.classList.add('active');
        }


        // --- View Rendering Logic ---
        function renderView(viewName) {
            let htmlContent = '';
            const isDarkMode = document.body.classList.contains('dark-mode');

            if (viewName === 'auth') {
                htmlContent = `
                    <div class="flex items-center justify-center min-h-screen">
                        <div class="max-w-md w-full bg-white p-8 rounded-xl shadow-lg ${isDarkMode ? 'dark:bg-gray-800' : ''}">
                            <h2 class="text-3xl font-bold text-center text-sub-header-light mb-6 ${isDarkMode ? 'dark:text-gray-200' : ''}">
                                Welcome to Family Library
                            </h2>
                            <form id="auth-form" class="space-y-4">
                                <div>
                                    <label for="auth-email" class="block text-sm font-medium text-gray-700 mb-1 ${isDarkMode ? 'dark:text-gray-300' : ''}">
                                        Email
                                    </label>
                                    <input type="email" id="auth-email" class="mt-1 block w-full
                                        px-3 py-2 border border-gray-300 rounded-md shadow-sm
                                        focus:outline-none focus:ring-purple-500 focus:border-purple-500
                                        ${isDarkMode ? 'dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600' : ''}">
                                </div>
                                <div>
                                    <label for="auth-password" class="block text-sm font-medium text-gray-700 mb-1 ${isDarkMode ? 'dark:text-gray-300' : ''}">
                                        Password
                                    </label>
                                    <input type="password" id="auth-password" class="mt-1 block w-full
                                        px-3 py-2 border border-gray-300 rounded-md shadow-sm
                                        focus:outline-none focus:ring-purple-500 focus:border-purple-500
                                        ${isDarkMode ? 'dark:bg-gray-700 dark:text-gray-200 dark:border-gray-600' : ''}">
                                </div>
                                <button type="submit" id="signin-btn" class="w-full btn-primary py-2 px-4 rounded-md text-white font-semibold">
                                    Sign In
                                </button>
                                <button type="button" id="signup-btn" class="w-full btn-secondary py-2 px-4 rounded-md font-semibold mt-2">
                                    Sign Up
                                </button>
                            </form>
                        </div>
                    </div>
                `;
            } else if (viewName === 'main') {
                const userDisplayName = userProfiles[userId] || userEmail || 'Guest';
                htmlContent = `
                    <div class="max-w-4xl mx-auto bg-white p-8 rounded-xl shadow-lg my-8 ${isDarkMode ? 'dark:bg-gray-800 dark:shadow-md' : ''}">
                        <div class="flex justify-between items-center mb-6">
                            <h1 class="text-4xl font-extrabold text-header-light ${isDarkMode ? 'dark:text-gray-50' : ''}">Family Library</h1>
                            <div>
                                <p class="text-lg font-semibold text-gray-800 ${isDarkMode ? 'dark:text-gray-200' : ''}">Hello, <span class="text-purple-700 ${isDarkMode ? 'dark:text-purple-300' : ''}">${userDisplayName}</span>!</p>
                                ${isAdmin ? `<p class="text-sm text-gray-600 ${isDarkMode ? 'dark:text-gray-400' : ''}">(Admin)</p>` : ''}
                                <button id="logout-btn" class="btn-red text-sm py-1 px-3 rounded-md mt-2">
                                    Logout
                                </button>
                            </div>
                        </div>

                        <div class="mb-8 p-4 bg-gray-50 rounded-lg shadow-inner ${isDarkMode ? 'dark:bg-gray-700 dark:border-gray-600' : ''}">
                            <h2 class="text-xl font-bold text-sub-header-light mb-3 ${isDarkMode ? 'dark:text-gray-200' : ''}">Your Profile</h2>
                            <form id="set-display-name-form" class="flex flex-col sm:flex-row items-center space-y-2 sm:space-y-0 sm:space-x-4">
                                <label for="display-name-input" class="text-gray-700 text-sm font-medium sr-only ${isDarkMode ? 'dark:text-gray-300' : ''}">Display Name:</label>
                                <input type="text" id="display-name-input" placeholder="Set your display name"
                                    value="${userDisplayName !== userEmail && userDisplayName !== 'Guest' ? userDisplayName : ''}"
                                    class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm
                                    focus:outline-none focus:ring-purple-500 focus:border-purple-500
                                    ${isDarkMode ? 'dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500' : ''}">
                                <button type="submit" class="btn-primary py-2 px-4 rounded-md text-white font-semibold flex-shrink-0">
                                    Set Display Name
                                </button>
                            </form>
                        </div>

                        <div class="tab-container">
                            <button class="tab-button active" data-tab="catalogue">Book Catalogue</button>
                            ${isAdmin ? `
                                <button class="tab-button" data-tab="manage">Manage Books</button>
                            ` : ''}
                        </div>

                        <div id="tab-catalogue" class="tab-content-panel active">
                            <h2 class="text-2xl font-bold text-sub-header-light mb-4 ${isDarkMode ? 'dark:text-gray-200' : ''}">Books Available</h2>
                            <input type="text" id="search-input" placeholder="Search by title or author..."
                                class="mb-4 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm
                                focus:outline-none focus:ring-purple-500 focus:border-purple-500
                                ${isDarkMode ? 'dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500' : ''}">
                            <div id="books-list" class="space-y-3">
                                </div>
                            <p id="no-books-message" class="text-gray-500 text-center mt-4 ${isDarkMode ? 'dark:text-gray-400' : ''} hidden">No books found.</p>
                        </div>

                        ${isAdmin ? `
                        <div id="tab-manage" class="tab-content-panel">
                            <div class="mb-8 p-6 bg-gray-50 rounded-lg shadow-inner ${isDarkMode ? 'dark:bg-gray-700 dark:border-gray-600' : ''}">
                                <h2 id="add-edit-form-title" class="text-2xl font-bold text-sub-header-light mb-4 ${isDarkMode ? 'dark:text-gray-200' : ''}">Add New Book</h2>
                                <form id="add-edit-book-form" class="space-y-4">
                                    <div id="isbn-search-section">
                                        <label for="isbn-search-input" class="block text-sm font-medium text-gray-700 mb-1 ${isDarkMode ? 'dark:text-gray-300' : ''}">
                                            ISBN (Optional for auto-fill)
                                        </label>
                                        <div class="flex space-x-2">
                                            <input type="text" id="isbn-search-input" placeholder="Enter ISBN to auto-fill"
                                                class="flex-grow px-3 py-2 border border-gray-300 rounded-md shadow-sm
                                                focus:outline-none focus:ring-purple-500 focus:border-purple-500
                                                ${isDarkMode ? 'dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500' : ''}">
                                            <button type="button" id="fetch-details-btn" class="btn-purple py-2 px-4 rounded-md font-semibold flex-shrink-0">
                                                Fetch Details
                                            </button>
                                        </div>
                                    </div>
                                    <div>
                                        <label for="book-title" class="block text-sm font-medium text-gray-700 mb-1 ${isDarkMode ? 'dark:text-gray-300' : ''}">
                                            Title <span class="text-red-500">*</span>
                                        </label>
                                        <input type="text" id="book-title" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm
                                            focus:outline-none focus:ring-purple-500 focus:border-purple-500
                                            ${isDarkMode ? 'dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500' : ''}">
                                    </div>
                                    <div>
                                        <label for="book-author" class="block text-sm font-medium text-gray-700 mb-1 ${isDarkMode ? 'dark:text-gray-300' : ''}">
                                            Author <span class="text-red-500">*</span>
                                        </label>
                                        <input type="text" id="book-author" required
                                            class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm
                                            focus:outline-none focus:ring-purple-500 focus:border-purple-500
                                            ${isDarkMode ? 'dark:bg-gray-600 dark:text-gray-200 dark:border-gray-500' : ''}">
                                    </div>
                                    <input type="hidden" id="book-isbn">
                                    <div class="flex space-x-2">
                                        <button type="submit" id="add-update-button" class="btn-primary py-2 px-4 rounded-md font-semibold">
                                            Add Book
                                        </button>
                                        <button type="button" id="cancel-edit-button" class="btn-secondary py-2 px-4 rounded-md font-semibold hidden">
                                            Cancel Edit
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                        ` : ''}
                    </div>
                `;
            }

            appDiv.innerHTML = htmlContent; // Render the main content

            // Attach event listeners after content is in the DOM
            if (viewName === 'auth') {
                document.getElementById('auth-form').addEventListener('submit', (e) => handleAuth(e, false));
                document.getElementById('signup-btn').addEventListener('click', (e) => handleAuth(e, true));
            } else if (viewName === 'main') {
                document.getElementById('logout-btn').addEventListener('click', handleLogout);
                document.getElementById('set-display-name-form').addEventListener('submit', handleSetDisplayName);
                document.getElementById('search-input').addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase();
                    const filteredBooks = books.filter(book =>
                        book.title.toLowerCase().includes(searchTerm) ||
                        book.author.toLowerCase().includes(searchTerm)
                    );
                    renderBookList(filteredBooks); // Render filtered books
                });

                // Attach tab listeners
                document.querySelectorAll('.tab-button').forEach(button => {
                    button.addEventListener('click', (e) => {
                        switchTab(e.target.dataset.tab);
                    });
                });

                if (isAdmin) {
                    document.getElementById('add-edit-book-form').addEventListener('submit', handleAddUpdateBook);
                    document.getElementById('fetch-details-btn').addEventListener('click', fetchBookDetailsByIsbn);
                    document.getElementById('cancel-edit-button').addEventListener('click', handleCancelEdit);
                }

                // Initial render of books (they will be fetched and re-rendered by setupRealtimeBooksListener)
                fetchAndRenderBooks(); // This also calls renderBookList internally
                // Ensure the catalogue tab is active by default when main view loads
                switchTab('catalogue');
            }
        }

        // --- Theme Toggling ---
        function applyTheme(theme) {
            const body = document.body;
            if (theme === 'dark') {
                body.classList.remove('light-mode');
                body.classList.add('dark-mode');
            } else {
                body.classList.remove('dark-mode');
                body.classList.add('light-mode');
            }
            localStorage.setItem('theme', theme);
        }

        function getPreferredTheme() {
            const storedTheme = localStorage.getItem('theme');
            if (storedTheme) {
                return storedTheme;
            }
            return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'dark' : 'light';
        }

        // --- Event Listeners and Initial Load ---
        document.addEventListener('DOMContentLoaded', async () => {
            console.log('DOMContentLoaded fired.');
            applyTheme(getPreferredTheme()); // Apply theme as early as possible
            document.body.classList.add('transition-colors', 'duration-300'); // Enable transition after initial theme set

            const footer = document.createElement('footer');
            footer.className = 'p-4 text-center text-gray-600 text-sm';
            footer.innerHTML = `
                <div class="container mx-auto">
                    <p>&copy; <span id="current-year"></span> Family Library. All rights reserved.</p>
                    <div class="flex justify-center items-center mt-2 space-x-4">
                        <button id="theme-toggle" class="px-3 py-1 rounded-full text-sm font-medium transition-colors duration-200 focus:outline-none focus:ring-2 focus:ring-opacity-75
                            bg-gray-200 text-gray-800 hover:bg-gray-300
                            dark:bg-gray-700 dark:text-gray-200 dark:hover:bg-gray-600">
                            Toggle Theme
                        </button>
                    </div>
                </div>
            `;
            document.body.appendChild(footer);

            document.getElementById('current-year').textContent = new Date().getFullYear();

            document.getElementById('theme-toggle').addEventListener('click', () => {
                const newTheme = ('light-mode') ? 'dark' : 'light';
                applyTheme(newTheme);
            });

            await initializeSupabase();
        });
    </script>
</body>
</html>
